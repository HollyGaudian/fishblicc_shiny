---
title: "_Harpadon nehereus_ Length Frequency Data Analysis"
author: "Bangladesh Stock Assessment Working Group"
date: "22 April 2023"
output: 
  html_document:
    toc: true
    code_folding: hide
    toc_depth: 2.0
    keep_md: false
    fig_caption: true
    df_print: paged
---

```{r setup, include=FALSE}
library("here")
library("statmod")
library("tibble")
library("dplyr")
options(dplyr.summarise.inform=FALSE)
library("tidyr")
library("readr")
library("readxl")
library("ggplot2")
library("cowplot")
theme_set(theme_cowplot())
library("ggExtra")  # Marginal histogram
library("flextable")
library("Rcpp")
library("rstan")
library("posterior")
library("bayesplot")
# library("gtsummary")
library("modelsummary")
library("fishblicc")
#system2("powershell", args=c("Set-Content", "-Path", paste0(here(),"\\.git"), "-Stream", "com.dropbox.ignored", "-Value", "1"))
system2("powershell", args=c("Set-Content", "-Path", paste0(here(),"\\.Rproj.user"), "-Stream", "com.dropbox.ignored", "-Value", "1"))

set_flextable_defaults(digits=2)

species_name <- "Harpadon nehereus"
bansis_code <- "SYNHA01"
# NEED TO INSTALL THE REPOS VERSION FOR rstan to run in R4.2 / rtools42 

# remove.packages("rstan")
# remove.packages("StanHeaders")
# install.packages("StanHeaders", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
# install.packages("rstan", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))

# Install fishblicc
# remotes::install_github("PaulAHMedley/fishblicc")
Table_Number <- 1
```


# Introduction  

The following assessment uses information on growth, maturity and length-weight to estimate the status of a stock based on a single length frequency sample. The objective is to compare the observed length composition with what would be expected if there were no fishing. This can be done using estimating mortalities and SPR calculations based on length at maturity.  

The method being applied is "data-limited". It requires relatively little data and information on the stock. The method can be used with a single length frequency sample and some indication of the mean maximum length of the fish ( $L_\infty$ ), although the assessment can be improved with additional information on the length-weight, length at 50% maturity and other "prior" information on selectivity, natural mortality and growth variability. For missing information, the method applies reasonable assumptions based on typical parameter values and life-history invariants.     


```{r LFData}
# load(file=here("data", "fishbase_downloads.rda"))
load(file=here("data", "BMFCBP_2012_2018.rda"))
rm(cbp_carrier_df, cbp_catch_df, cbp_maturity_df, cbp_socioecon_df, cbp_station_df, cbp_trip_df, cbp_vessel_owner_df)

ar_lfd <- cbp_lf_mst_df |>
       filter(sciname==species_name) |>
       left_join(cbp_lf_dtl_df, by="lwf_tranid") |>
       select(lwf_tranid, year, month, gear_type, gear_name, sciname, bansis_code, length_cm) |>
       filter(length_cm > 0, length_cm < 65)

sv_lfd <- read_csv(here("data", "bansis_len_freq_data.csv"), show_col_types = FALSE) |>
  mutate(sciname = case_when(sciname == "Ariomma indicum" ~ "Ariomma indica",
                             sciname == "Stolephorus buccaneeri *" ~ "Stolephorus buccaneeri",
                             TRUE ~ sciname)) |>
  filter(sciname==species_name)
```


# Data Evaluation

The selectivity modeled in `fishblicc` consist of single-mode parametric functions. Therefore, if the length frequency data have more than one mode, the model will not be able to fit to the data well. With this in mind, the potential categorical variables (primarily the gear description) are reviewed.    

The length frequency data are prepared by combining the survey and artisanal data by gear (selectivity) category into 1cm length bins to reduce observation error.  

It is important to note that significant catches are taken by the trawl fishery for which there are no length frequency data at the present time. 

A problem arises in how to parameterise selectivity. There are multiple gears catching different lengths. Whereas the set bagnet has only two gear types, the gillnet has many with widely varying length compositions.   
```{r GenerateSingleDataSet}
length_bin_width <- 1

# Combine data sources
lf_df <- rbind(mutate(sv_lfd, 
                      length_cm = length_bin_width*floor(length_cm/length_bin_width)) |>
               group_by(year, month, sciname, length_cm) |>
               summarise(fq=sum(frequency)) |>
               mutate(source="Survey",  
                      gear_type="Trawl Survey", gear_name="Trawl Survey") |>
               ungroup(),
             mutate(ar_lfd, length_cm = length_bin_width*floor(length_cm/length_bin_width)) |>
               group_by(year, month, sciname, length_cm, gear_type, gear_name) |>
               summarise(fq=n()) |>
               mutate(source="BMFCBP") |>
               ungroup())
```


```{r PlotSingleDataSet, fig.cap = "__Fig. Observed length frequency for each gear type__"}
lf_df |>
  group_by(gear_type, length_cm) |>
  summarise(fq=sum(fq)) |>
  ggplot(aes(x=length_cm, y=fq, fill=gear_type)) +
    geom_col(alpha = 0.5, position="dodge") +
    facet_wrap(vars(gear_type))
```


```{r filter_data}
lf_df <- filter(lf_df, gear_type %in% c("Gill net", "Set Bagnet", "Trawl Survey"))
```


```{r plotgillnet1, fig.cap = "__Fig. Observed length frequency for the gillnet gears.__"}
filter(lf_df, gear_type == "Gill net") |>
  ggplot(aes(x=length_cm, y=fq, fill=gear_name)) +
    geom_col(alpha = 0.8, position="stack")
```


```{r plotbagnet1, fig.cap = "__Fig. Observed length frequency for the set bagnet gears.__"}
filter(lf_df, gear_type == "Set Bagnet") |>
  ggplot(aes(x=length_cm, y=fq, fill=gear_name)) +
    geom_col(alpha = 0.8, position="stack")
```

Even the survey data exhibits a wide spread in lengths without a single mode which can not be explained by the year or the month when the data were collected. The data should be re-examined to evaluate the effect of station on the size composition.  

Because the survey does not contribute to fishing mortality, these data can be dropped from the analysis. Given the cost of collection, it is better if it could be included in future, but this might require a better understanding how the survey interacts with this species.  

```{r plotsurvey1, fig.cap = "__Fig. Observed length frequency for the scientific survey, high-lighting year (top) and month (bottom) contributions.__"}
plot_grid(filter(lf_df, gear_type == "Trawl Survey") |>
            ggplot(aes(x=length_cm, y=fq, fill=year)) +
            geom_col(alpha = 0.8, position="stack"),
          filter(lf_df, gear_type == "Trawl Survey") |>
            ggplot(aes(x=length_cm, y=fq, fill=month)) +
            geom_col(alpha = 0.8, position="stack"),
          nrow=2)
```


```{r SelectFinalLF}
#Convert length frequencies to lists within the tibble. Each field will now contain a length vector and a full length frequency vector in each record
ldf <- lf_df |> 
  group_by(gear_type, gear_name, year, month) |> 
  summarize(lbs = list(length_cm), fqs = list(fq)) |>
  ungroup()

# Produce a summary of the data as a table
ldf |>
  mutate(fq = purrr::map_dbl(fqs, sum)) |>  # purrr package is required to deal with lists
  group_by(gear_type, gear_name) |>
  summarise(No.Fish = sum(fq)) |>
  arrange(gear_type, gear_name) |>
  flextable() |>
  set_caption(as_paragraph("Table ", as.character(Table_Number), 
                           " : Number of fish measured by gear type")) |>
  autofit()
Table_Number <- Table_Number + 1
```

The vast majority of the catches are taken in the set bagnet fishery, particularly the marine set bagnet. The estuarine set bagnet clearly takes more juveniles and has a different selectivity. The trawl survey also potentially has a different selectivity, generally having a more diverse catch.   

The other gears are a complex mix of small data sets. These were examined for patterns related to the gear name and year, but no simple relationships were found. There is in general no evidence that different gillnets have different selectivities, so these were combined into a single gear. Marine and estuarine bagnets were kept separate.  

# Priors  

Priors are an important part of the analysis. The aim is to build a table of reasonable priors for justifying the choices made. Ideally, parameters are estimated for the local stock, as they can vary dependent on local conditions. In practice, published estimates may need to be used to inform a likely range and hence prior probability in many cases. 

With the exception of Linf which applies a normal distribution, the priors in the model are constructed around lognormal distributions. In general, we can use default standard for most parameters.  The two parameters which usually have little support from the data and therefore require informative priors are the natural mortality and mean asymptotic length.  Maturity and length-weight parameters (L50, L95, a, b) are fixed to calculate the SPR.  

## Length-weight Model Parameters (a, b)

For the available length-weight data, a simple log linear regression is applied to estimate the parameters $a$ and $b$.  

For the purposes here, an overall average length-weight relationship is required to estimate weight and how it changes with length. The survey data are the most reliable data and therefore are used to estimate the relevant parameters. The length-weight parameters estimated for the survey data and artisanal fishery data collection were not found significantly different. The artisanal data contains a significant number of errors (mis-recorded weights) and generally adds uncertainty to the estimate rather than improve it.  

```{r lwdata_modelfit}
lwd <- read_csv(here("data", "bansis_len_wt_data.csv"), 
                show_col_types = FALSE) |>
  filter(species == bansis_code) |>
  mutate(sciname=species_name, source="survey") |>
  select(source, sciname, length_cm, weight_g=weight_gm) |>
  filter(length_cm > 0, weight_g > 0) |>
  mutate(llength_cm = log(length_cm),
         lweight_g = log(weight_g))

lwd <- filter(lwd, source=="survey")
mod <- summary(lm(formula = lweight_g ~ llength_cm, data=lwd)) 
#mod
a <- exp(mod$coef[1,1])
b <- mod$coef[2,1]
loga <- mod$coef[1,1]
loga_se <- mod$coef[1,2]
b_se <- mod$coef[2,2]
```


```{r lwdata2, fig.cap = "__Fig. Length-weight log-log regression.__"}
ggplot(lwd, aes(x=llength_cm, y=lweight_g)) +
  geom_point(show.legend=FALSE) +
  scale_size_continuous(range = c(0.5,2)) +
  labs(x="log-length (cm)", y="log-weight (g)", title=species_name) +
  geom_smooth(method="lm", formula=y~x)
```


```{r lwdata_table}
list("Estimates"=mod) |>
  modelsummary(output = 'flextable', 
               statistic = NULL, 
               estimate=c("{estimate}  [{conf.low}, {conf.high}]"),
               gof_omit = "RMSE|R2 Adj.") |>
  set_caption(as_paragraph("Table ", as.character(Table_Number), 
                           " : Length-weight regression")) |>
  autofit()
Table_Number <- Table_Number + 1
```

## Linf, Length at 50% Maturity  

The average asymptotic length is reported as 39cm and length at first maturity 13cm (www.fishbase.se). The working group believed that the asymptotic length is realistic, but this estimate of length at 50% maturity may be too low. Further literature review was recommended to find alternative more reliable estimates.  

```{r LifeHistory, message=F}
sp_par <- read_xlsx(path=here("data", "stock_parameters.xlsx"), 
                    sheet="parms") |>
  dplyr::select(Species, LWa_pub, LWb_pub,	vonBLinf,	
                vonBLinf_lo, vonBLinf_hi, vonBT0, vonBk, Lmat, Lmax)

sp_par <- sp_par |> 
  filter(Species==species_name)

flextable(sp_par) |>
  set_caption(as_paragraph("Table ", as.character(Table_Number), 
                           " : ", as_i(species_name), 
                           " life history parameters from www.fishbase.org")) |>
  autofit()
Table_Number <- Table_Number + 1

# ( from fishbase)
L50 <- sp_par$Lmat 
L95 <- sp_par$Lmat+5
Linf <- c(sp_par$vonBLinf, 5)

Galpha <- 100 # default
```

The Linf parameter (39cm) is provided from fishbase and was considered acceptable by the working group. The length at 50% maturity from the same source (13cm) was considered low by the working group but retained until an improved estimate could be provided.  

## Natural Mortality

There are two clear options for estimating natural mortality based on either the growth equation or "life history invariant". Neither will be particularly accurate, but they may provide indications of the likely range for this parameter.  

```{r Priors2}
# Get natural mortality based on growth parameters
NatMort_Growth <- function(Linf, K, Tempr) {
  #' Natural mortality estimate   
  #' based on Griffiths and Harrod (2007) species regression
  return(10^(0.102 - 0.066*log10(Linf) + 0.814*log10(K) + 0.19*log10(Tempr)))
}

NatMort_LHI <- function(Linf, Lm, b) {
  # Life history invariant estimate
  return(b*(Linf[1]-Lm)/Lm)
}

GR_MK <- NatMort_Growth(sp_par$vonBLinf, sp_par$vonBk, 28.5)/sp_par$vonBk
LH_MK <- NatMort_LHI(Linf[1], L50, b)

tibble(Growth=GR_MK, Life_History=LH_MK) |>
  flextable() |>
  set_caption(as_paragraph("Table ", as.character(Table_Number), 
               " : M/K estimated from growth and life history 'invariant' models")) |>
  autofit()
Table_Number <- Table_Number + 1
```

In this instance the life history invariant estimate seems unrealistically high compared to a "normal" value of around 1.5. The estimate of length at first maturity, being a poor estimate of the length at 50% maturity, may be introducing significant bias. The growth based estimate seems more realistic and this is used for the prior.  


```{r TidyUp, include=F}
rm(lwd, mod)
```


## Summary

The selectivity is treated as a parametric function of length only. The model would support any selectivity function, but it becomes impossible to estimate other parameters of interest if selectivity is too flexible. It is therefore necessary to impose some constraints on possible selectivity functions. The two primary functions considered here are the logistic and the double-sided normal distribution.  

```{r ParameterTable1}

tibble(Param=c("Mk", "Fk", "Linf", "Galpha", "Sm", "NB_phi", "Fixed Parameters", "b", "Lm", "Ls"), 
       Description=c("Natural mortality in time units of growth rate k.",
                     "Fishing mortality in time units of growth rate k for each gear.",
                     "Mean asymptotic length at infinite age.",
                     "Gamma probability distribution parameter for the variation \n in length at age (inverse of CV).",
                     "Selectivity at length parameters for all gears, including the maximum selectivity and steepness for the left and right side. Selectivity functions have 2 or 3 parameters each.",
                     "Negative binomial over-dispersion parameter, so (mean^2)/NB_phi \n is the additional variance over the standard poisson variance.",
                     "",
                     "Exponent of the length-weight relationship.",
                     "Length at 50% maturity for the maturity logistic function.",
                     "Steepness of the maturity logistic function.")) |>
  flextable() |> 
  set_caption(as_paragraph("Table ", as.character(Table_Number), 
                           " : fishblicc model parameters")) |>
  autofit()
Table_Number <- Table_Number + 1
```

The catches between the gillnets and bagnets are assumed proportional to the length frequency sample size. the data can be combined into a single length frequency. This is not ideal because it limits advice separate management actions for each bagnet type. Combining the data will adjust the shape of the selectivity curves to account for combined size frequency distribution.  

```{r DataObject_Stan1}

# Change to 3 gears: gillnet, estuarine set bagnet and marine set bagnet
ls_df <- lf_df |>
#  filter(gear_type != "Trawl Survey") |>
  mutate(gear_type = ifelse(gear_type == "Set Bagnet", gear_name, gear_type)) |>
  group_by(gear_type, length_cm) |>
  summarise(fq = sum(fq)) |>
  ungroup()

lfd_df <- ls_df |>
  dplyr::select(gear=gear_type, len=length_cm, fq=fq) |>
  rbind(tibble(gear = "Dummy", 
               len = seq(min(ls_df$length_cm), 
                         max(ls_df$length_cm)+length_bin_width, 
                         by=length_bin_width),
               fq=0 )) |>
  pivot_wider(names_from=gear, values_from=fq, values_fill=0) |>
  dplyr::select(-Dummy) |>
  arrange(len)

lf_df_wt <- as.list(lfd_df[, 2:4])

etot <- sum(lfd_df$`Estuarine Set bagnet`) 
mtot <- sum(lfd_df$`Marine Set bagnet`)
gtot <- sum(lfd_df$`Gill net`)
cprop <- c(etot/(etot+mtot+gtot), gtot/(etot+mtot+gtot), mtot/(etot+mtot+gtot))

dl <- blicc_dat(
  LLB = lfd_df$len,
  fq = lf_df_wt,
  Linf = c(sp_par$vonBLinf, 2),
  #sel_fun = c("ds_normal", "ds_normal", "logistic"),  # Selectivity function indices: 1 = logistic, 2 = normal, 3 = ss_normal, 4 = dsnormal
  sel_fun = c(4L, 4L, 1L),  
  Catch = cprop,
  gear_names = c("Estuarine set bagnet", "Gill net", "Marine set bagnet"),
  Mk = GR_MK,
  a = a,
  b = b,
  L50 = L50,
  L95 = L95
)

rm(lf_df_wt)
rm(etot, mtot, gtot)
```

The following table provides a final summary of the priors that will be applied. In most cases lognormal priors are applied as these do not dominate estimates, but also prevent parameters being negative where this is appropriate.  

The exception is the Linf estimate. The prior on the asymptotic mean length is expected to be informative and symmetrical around the best estimate, so a normal prior is applied to this parameter.   

```{r PriorSummary}
blicc_priors(dl) |>
  flextable() |> 
  colformat_double(digits=3) |>
  set_caption(as_paragraph("Table ", as.character(Table_Number), 
               " : Summary of priors used in the fishblicc model")) |>
  autofit()
Table_Number <- Table_Number + 1
```


# Base Model Fit

The initial maximum posterior density fit of the default model was used as the basis for determining the final model structure through sensitivity runs where alternative assumptions are tested. The default model used all data, excepting fish above the maximum length reported elsewhere (65cm), and assumed dome-shaped selectivity for estuarine set bagnet and gillnet, and logistic selectivity for marine set bagnet.  

```{r FitMultigear_Stan2}
stf <- blicc_mpd(dl)
res_rp <- blicc_ref_pts(stf, dl)
```

Relevant statistics show that the MCMC converged and there were no problems with the fitting algorithm.  

```{r table_results1}
# Table parameter estimates
res_rp$rp_df |> 
  dplyr::select(Linf:Mk, NB_phi:lp__) |> 
  flextable::flextable() |>
  flextable::set_caption(as_paragraph("Table ", as.character(Table_Number), 
                         " : parameter estimates for the ", 
               as_i(species_name), " base model fit")) |>
  autofit()
Table_Number <- Table_Number + 1
```


```{r plot_results1, fig.cap = "__Fig. Observed-expected length frequency for the base model__"}
plot_expected_frequency(res_rp, Gear = 1:3)
```

Both the Galpha parameter and the NB_phi are relatively low values indicating high growth variability and high observation error respectively. The fitted Galpha parameter indicates a growth CV=23% compared to the default CV=10%. The increased estimated growth variability is due to the presence of a small number of larger fish in the samples. These were included up to 65cm because Fishbase reports estimates of Linf to 60cm. The model accounts for these by having a higher growth variability which is not unreasonable, but also implies length is not a good indicator of age. The high observation error may be due to a number of factors, including process error (e.g. recruitment variation) as well as actual observation error (random sampling effects and low measurement precision).  

The residuals demonstrate the very poor fit of the model to the largest sized fish, where there are very large outliers. These outliers result from the presence of relatively small numbers of fish around 60cm length.  

```{r ResidPlot, fig.cap = "__Fig. Residual plot for the base model__"}
plot_residuals(res_rp) 
```

The gill net shows clear dome-shape, whereas the estuarine set bagnet continues to catch some larger fish, so this pattern is less clear. The marine set bagnet is a logistic selectivity.  

```{r Selectivity_base, fig.cap = "__Fig. Fitted selectivities for the base model__"}
plot_selectivity(res_rp)
```

The estimated current SPR is between 20 and 30%. This is very similar to the result found in the previous stock assessment in 2018. However, the absolute estimate of fishing mortality appears more realistic.  

Likewise the marine set bagnet length composition should be a little more sensitive because it is not domed selectivity. However, there is an advantage in catch curves in the selectivity taking smaller fish, which offsets the estuarine bagnet domed selectivity. Gill net performed the worst, and also has the noisiest data. However, results do suggest using all three gears (four when trawl can be included) is likely to more informative than relying on one gear alone.  

Overall, this model gave a reasonable fit to the data and provided a good basis for evaluating alternative model assumptions.  

```{r Summary_Original}
Summary_Table <- res_rp$rp_df |> 
  mutate(Sensitivity = "Original Base Model", `Retain/Reject` = "") |>
  dplyr::select(Sensitivity, Linf:Mk, SPR:lp__, `Retain/Reject`) 
```


# Sensitivities

Note that commercial trawl is not included in this assessment and it should be. Including these data could change the perception of the stock.  

The following sensitivities are not exhaustive. Particularly, data might be accumulated differently to create more "gears" or data may be removed in more ways to test sensitivity to potential errors or changes in the underlying assumptions.  

Catches between artisanal gears have been assumed to be proportional to the length frequency sample sizes. This might be re-assessed.   

It is not possible to test fully all assumptions this way, dependent on the data and how it has been collected. The assumption that the stock is in a steady state over the period the data are collected could be tested, for example, by dividing the data set into two and seeing whether the estimates change significantly between them. Interpreting results for this sort of procedure may not be simple however.  

## Exclude large fish data (>45cm)

If the prior on Linf is loosened in the base model above, the model fitted a much higher Linf (>70cm) to explain large fish in the samples. The consensus view of the working group was that the lengths above 45cm are too high for the species in Bangladesh waters. It also is known that the artisanal data has significant inaccuracies (e.g. from the length-weight data). Therefore, the relatively few observations of larger fish were removed, on the basis these are unreliable and over-influential on the results. Filtering the data removed 45 out of the total 18890 fish that were measured.   

```{r RemoveLargeFish}
lf_df_wt_sens <- as.list(filter(lfd_df, len <= 45)[, 2:4])

dl_sens <- blicc_dat(
  LLB = lfd_df$len[lfd_df$len<=45],
  fq = lf_df_wt_sens,
  Linf = c(sp_par$vonBLinf, 2),
  sel_fun = c(4L, 4L, 1L),  # Selectivity function indices: 1 = logistic, 2 = normal, 3 = ss_normal, 4 = ds_normal
  Catch = cprop,
  gear_names = c("Estuarine set bagnet", "Gill net", "Marine set bagnet"),
  Mk = GR_MK,
  a = a,
  b = b,
  L50 = L50,
  L95 = L95
)

stf <- blicc_mpd(dl_sens)
res_rp <- blicc_ref_pts(stf, dl_sens)
```

The resulting fit is much improved with the log-probability at the mode (lp__) significantly increased from -743 to -591.  

```{r ResultsTable_RemoveLargeFish}
# Table parameter estimates
res_rp$rp_df |> 
  dplyr::select(Linf:Mk, NB_phi:lp__) |> 
  flextable::flextable() |>
  flextable::set_caption(as_paragraph("Table ", as.character(Table_Number), 
                         " : parameter estimates for the ", 
               as_i(species_name), " exclude largest fish model fit")) |>
  autofit()
Table_Number <- Table_Number + 1
```

```{r obsLFQ_RemoveLargeFish, fig.cap = "__Fig. Observed-expected length frequency for the exclude largest fish model__"}
plot_expected_frequency(res_rp, Gear = 1:3)
```

The residual plot shows the removal of extreme outliers.  

```{r ResidPlot_RemoveLargeFish, fig.cap = "__Fig. Residual plot for the exclude largest fish model__"}
plot_residuals(res_rp) 
```

The working group decided to make this model the new base case. It was believed that the few large fish were most likely incorrectly reported.  

```{r UpdateDataSet}
Summary_Table <- rbind(Summary_Table,
  res_rp$rp_df |> 
    mutate(Sensitivity = "Remove Largest Fish", 
           `Retain/Reject` = "Base") |>
    dplyr::select(Sensitivity, Linf:Mk, SPR:lp__, `Retain/Reject`))
base_lfd_df <- filter(lfd_df, len <= 45)
etot <- sum(base_lfd_df$`Estuarine Set bagnet`) 
mtot <- sum(base_lfd_df$`Marine Set bagnet`)
gtot <- sum(base_lfd_df$`Gill net`)
cprop <- c(etot/(etot+mtot+gtot), gtot/(etot+mtot+gtot), mtot/(etot+mtot+gtot))
dl <- dl_sens
dl$model_name = "Base model"
```


## All Logistic Selectivity Functions

The default selectivity allowed dome-shaped curves for two gears, but enforced a flat-topped selectivity for the marine set bagnet. An alternative is to enforce flat-topped selectivity for all gears.   

```{r AllLogistic}
#lf_df_wt_sens <- as.list(base_lfd_df[, 2:4])

dl_sens <- blicc_selfun(dl, Gear=1:3, 
                        sel_fun=c(1,1,1),
                        model_name = "All logistic selectivity")

stf <- blicc_mpd(dl_sens)
res_rp <- blicc_ref_pts(stf, dl_sens)
```
In general, the model fit changed little, except the gill net had relatively worse outliers however. The log-probability falls slightly due to the removal of the priors for the right-hand side of the dome-shaped functions. The specification of these priors might be improved.  

It might be expected that logistic selectivity would lead to a lower SPR, and therefore be a more precautionary assumption. However, in these multigear models this does not always appear to be true, and in this case the SPR is raised slightly compared to when only one gear has flat-topped selectivity.  

```{r ResultsTable_AllLogistic}
# Table parameter estimates
res_rp$rp_df |> 
  dplyr::select(Linf:Mk, NB_phi:lp__) |> 
  flextable::flextable() |>
  flextable::set_caption(as_paragraph("Table ", as.character(Table_Number), 
                         " : Parameter estimates for the ", 
               as_i(species_name), " all logistic model fit")) |>
  autofit()
Table_Number <- Table_Number + 1
```

```{r obsLFQ_AllLogistic, fig.cap = "__Fig. Observed-expected length frequency for all logistic model__"}
plot_expected_frequency(res_rp, Gear = 1:3)
```


```{r ResidPlot_AllLogistic, fig.cap = "__Fig. Residual plot for the all logistic model__"}
plot_residuals(res_rp) 
```

```{r Summary_AllLogistic}
Summary_Table <- rbind(Summary_Table,
  res_rp$rp_df |> 
    mutate(Sensitivity = "All logistic selectivity", 
           `Retain/Reject` = "Reject") |>
    dplyr::select(Sensitivity, Linf:Mk, SPR:lp__, `Retain/Reject`))
```


## All Double-sided Normal Selectivity Functions  

Applying all fits with double-sided normal improves the fit significantly (although an extra parameter is fitted), and the stock status is worsened. 

However, it should be noted that differences in fits are small between the selectivity functions as the model can adjust the fit in other ways. 

```{r AllDSNormal}
dl_sens <- blicc_selfun(dl, Gear=1:3, 
                        sel_fun=c(4, 4, 4),
                        model_name = "All ds-normal selectivity")

stf <- blicc_mpd(dl_sens)
res_rp <- blicc_ref_pts(stf, dl_sens)
```


```{r ResultsTable_AllDSNormal}
# Table parameter estimates
res_rp$rp_df |> 
  dplyr::select(Linf:Mk, NB_phi:lp__) |> 
  flextable::flextable() |>
  flextable::set_caption(as_paragraph("Table ", as.character(Table_Number), 
                         " : Parameter estimates for the ", 
               as_i(species_name), " all double-sided normal model fit")) |>
  autofit()
Table_Number <- Table_Number + 1
```

```{r obsLFQ_AllDSNormal, fig.cap = "__Fig. Observed-expected length frequency for all double-sided normal model__"}
plot_expected_frequency(res_rp, Gear = 1:3)
```


```{r ResidPlot_AllDSNormal, fig.cap = "__Fig. Residual plot for the all double-sided normal model__"}
plot_residuals(res_rp) 
```


```{r Summary_AllDSNormal}
Summary_Table <- rbind(Summary_Table,
  res_rp$rp_df |> 
    mutate(Sensitivity = "All double-sided normal selectivity", 
           `Retain/Reject` = "Base") |>
    dplyr::select(Sensitivity, Linf:Mk, SPR:lp__, `Retain/Reject`))
dl <- dl_sens # new base
```


## Change Maturity

Changing the length at 50% maturity does not affect the fitted model. The maturity parameters are only used to calculate the SPR. Raising the size at maturity will generally worsen the stock status. 

The alternative length at 50% maturity (L50) is chosen to be consistent with the growth based M/K by reversing the life history invariant model. The L50 parameter does not affect the model fit, just the SPR calculation.   

```{r RaiseL50}
alt_L50 <- Linf[1]/(GR_MK/b + 1) # inverse of the life-history invaraint M model

res_rp <- blicc_ref_pts(stf, dl_sens, L50=alt_L50)
```


```{r ResultsTable_RaiseL50}
# Table parameter estimates
res_rp$rp_df |> 
  dplyr::select(Linf:Mk, NB_phi:lp__) |> 
  flextable::flextable() |>
  flextable::set_caption(as_paragraph("Table ", as.character(Table_Number), 
                         " : Parameter estimates for the ", 
               as_i(species_name), " raised L50 model fit")) |>
  autofit()
Table_Number <- Table_Number + 1
```



```{r Summary_RaiseL50}
Summary_Table <- rbind(Summary_Table,
  res_rp$rp_df |> 
    mutate(Sensitivity = "Raised L50", 
           `Retain/Reject` = "Base") |>
    dplyr::select(Sensitivity, Linf:Mk, SPR:lp__, `Retain/Reject`))
```


## Length-specific M  

A standard approach to modelling length-specific natural mortality is to assume natural mortality is inversely proportional to length (Lorenzen 1996). This general form for the function is easy to include in fishblicc, by setting the fixed natural mortality from the empirical estimates above to the natural mortality at the mean length. A vector can be used to set the proportional length-specific natural mortality.   

```{r LorenzenM}
lf_df_wt_sens <- as.list(base_lfd_df[, 2:4])
mean_length <- sum(unlist(lf_df_wt_sens) * 
                          rep((base_lfd_df$len + 0.5), dl$NG)) / 
               sum(unlist(lf_df_wt_sens))

dl_sens <- blip_Mk(dl, ref_length=mean_length)

stf <- blicc_mpd(dl_sens)
res_rp <- blicc_ref_pts(stf, dl_sens)
```


```{r ResultsTable_LorenzenM}
# Table parameter estimates
res_rp$rp_df |> 
  dplyr::select(Linf:Mk, NB_phi:lp__) |> 
  flextable::flextable() |>
  flextable::set_caption(as_paragraph("Table ", as.character(Table_Number), 
                         " : parameter estimates for the ", 
               as_i(species_name), 
               " inverse-length natural mortality model fit")) |>
  autofit()
Table_Number <- Table_Number + 1
```

```{r obsLFQ_LorenzenM, fig.cap = "__Fig. Observed-expected length frequency for the inverse-length natural mortality model__"}
plot_expected_frequency(res_rp, Gear = 1:3)
```

The residual plot shows the removal of extreme outliers.  

```{r ResidPlot_LorenzenM, fig.cap = "__Fig. Residual plot for the inverse-length natural mortality model__"}
plot_residuals(res_rp) 
```

While this cannot be considered the only evidence to reject this approach, the inverse-length natural mortality model results in a worse fit to the data shown by the decrease in log-probability at the mode.  

```{r Summary_LorenzenM}
Summary_Table <- rbind(Summary_Table,
  res_rp$rp_df |> 
    mutate(Sensitivity = "Inverse-length natural mortality", 
           `Retain/Reject` = "Sensitivity") |>
    dplyr::select(Sensitivity, Linf:Mk, SPR:lp__, `Retain/Reject`))
```


## Higher M  

The alternative Mk estimate to use is derived from the life history invariant estimate. This estimate is very high, but perhaps more consistent with the maturity estimate being used.  


```{r HighM}
lf_df_wt_sens <- as.list(base_lfd_df[, 2:4])

dl_sens <- blip_Mk(dl, lMk=c(log(LH_MK), 0.1))

stf <- blicc_mpd(dl_sens)
res_rp <- blicc_ref_pts(stf, dl_sens)
```

```{r ResultsTable_HighM}
# Table parameter estimates
res_rp$rp_df |> 
  dplyr::select(Linf:Mk, NB_phi:lp__) |> 
  flextable::flextable() |>
  flextable::set_caption(as_paragraph("Table ", as.character(Table_Number), 
                         " : parameter estimates for the ", 
               as_i(species_name), 
               " inverse-length natural mortality model fit")) |>
  autofit()
Table_Number <- Table_Number + 1
```

```{r obsLFQ_HighM, fig.cap = "__Fig. Observed-expected length frequency for the life history invariant natural mortality model__"}
plot_expected_frequency(res_rp, Gear = 1:3)
```

The general fit degraded, with a lower log-probability.    

```{r ResidPlot_HighM, fig.cap = "__Fig. Residual plot for the life history invariant natural mortality model__"}
plot_residuals(res_rp) 
```

Overall, the working group decided that this estimate of life history invariant natural mortality was unrealistically high and rejected this model.  


```{r Summary_HighM}
Summary_Table <- rbind(Summary_Table,
  res_rp$rp_df |> 
    mutate(Sensitivity = "Life history invariant natural mortality", 
           `Retain/Reject` = "Reject") |>
    dplyr::select(Sensitivity, Linf:Mk, SPR:lp__, `Retain/Reject`))
```


## Fitted Linf

Rather than set the Linf at a particular value, the prior can be loosened so that the model the Linf to the data. This is achieved by changing the prior sigma hyperparameter from 2cm to 10cm.   

The results favour a much higher (unrealistically higher) Linf and a much lower resulting SPR.  

```{r FittedLinf}
dl_sens <-blip_Linf(dl, Linf = c(sp_par$vonBLinf, 10))

stf <- blicc_mpd(dl_sens)
res_rp <- blicc_ref_pts(stf, dl_sens)
```


```{r ResultsTable_FittedLinf}
# Table parameter estimates
res_rp$rp_df |> 
  dplyr::select(Linf:Mk, NB_phi:lp__) |> 
  flextable::flextable() |>
  flextable::set_caption(as_paragraph("Table ", as.character(Table_Number), 
                         " : Parameter estimates for the ", 
               as_i(species_name), " estimated Linf model fit")) |>
  autofit()
Table_Number <- Table_Number + 1
```

```{r obsLFQ_FittedLinf, fig.cap = "__Fig. Observed-expected length frequency for the estimated Linf model__"}
plot_expected_frequency(res_rp, Gear = 1:3)
```

The general fit of this model was degraded compared to the base model, with a lower log-probability.    

```{r ResidPlot_FittedLinf, fig.cap = "__Fig. Residual plot for the estimated Linf model__"}
plot_residuals(res_rp) 
```

While the model shows some improvement in fit, the working group rejected this model as the estimate of Linf was unrealistically high.   

```{r Summary_FittedLinf}
Summary_Table <- rbind(Summary_Table,
  res_rp$rp_df |> 
    mutate(Sensitivity = "Estimated Linf", 
           `Retain/Reject` = "Reject") |>
    dplyr::select(Sensitivity, Linf:Mk, SPR:lp__, `Retain/Reject`))
```

## Include survey data  

Note that catch of the survey data is neglible, so the catch was set to zero (implying zero fishing mortality for this gear).  

The survey are bimodal, so are not fitted well at all. Therefore, the working group agreed that unless a better interpretation can be found (such as accounting for fishing station), the survey data should not be included.   

```{r AddSurvey}
lf_df_wt_sens <- as.list(base_lfd_df[, 2:5])

etot <- sum(base_lfd_df$`Estuarine Set bagnet`) 
mtot <- sum(base_lfd_df$`Marine Set bagnet`)
gtot <- sum(base_lfd_df$`Gill net`)
cprop_surv <- c(etot/(etot+mtot+gtot), gtot/(etot+mtot+gtot), mtot/(etot+mtot+gtot), 0)

dl_sens <- blicc_dat(
  model_name = "Harpadon_nehereus: Include Survey",
  LLB = base_lfd_df$len,
  fq = lf_df_wt_sens,
  Linf = c(sp_par$vonBLinf, 2),
  sel_fun = c(4L, 4L, 4L, 4L),  # Selectivity function indices: 1 = logistic, 2 = normal, 3 = ss_normal, 4 = ds_normal
  Catch = cprop_surv,
  gear_names = c("Estuarine set bagnet", "Gill net", "Marine set bagnet", "Trawl survey"),
  Mk = GR_MK,
  a = a,
  b = b,
  L50 = L50,
  L95 = L95
)

stf <- blicc_mpd(dl_sens)
res_rp <- blicc_ref_pts(stf, dl_sens)
```


```{r ResultsTable_IncludeSurvey}
# Table parameter estimates
res_rp$rp_df |> 
  dplyr::select(Linf:Mk, NB_phi:lp__) |> 
  flextable::flextable() |>
  flextable::set_caption(as_paragraph("Table ", as.character(Table_Number), 
                         " : Parameter estimates for the ", 
               as_i(species_name), " include survey data model fit")) |>
  autofit()
Table_Number <- Table_Number + 1
```

```{r obsLFQ_IncludeSurvey, fig.cap = "__Fig. Observed-expected length frequency for include survey model__"}
plot_expected_frequency(res_rp, Gear = 1:4)
```


```{r ResidPlot_IncludeSurvey, fig.cap = "__Fig. Residual plot for the include survey model__"}
plot_residuals(res_rp) 
```


```{r Summary_IncludeSurvey}
Summary_Table <- rbind(Summary_Table,
  res_rp$rp_df |> 
    mutate(Sensitivity = "Include survey data", 
           `Retain/Reject` = "Reject") |>
    dplyr::select(Sensitivity, Linf:Mk, SPR:lp__, `Retain/Reject`))
```


## Sensitivity Summary

```{r SensitivitiesSummaryTable}
Summary_Table |> 
  flextable::flextable() |>
  flextable::set_caption(as_paragraph("Table ", as.character(Table_Number), 
                         " : Selected model estimates comparing the different sensitivities examined and the working group decision.")) |>
  autofit()
Table_Number <- Table_Number + 1
```

# Final Models

The working group decided that the base model should include the following:  
1. Fish greater than 45cm are excluded.  
2. Linf to have a normal prior with parameters 39 and 2.  
3. Survey data are excluded from the fit.  
4. Selectivity functions are double-sided normal for ALL gears.  
6. Prior natural mortality level uses the growth parameter based estimate of M/K: 2.11  
7. Length at 50% maturity chosen consistent with M/K  

Equal weight is given to the following models:  
1. Natural mortality fixed  
2. Natural mortality inversely related to length  

The final base models were fitted using MCMC to estimate full uncertainty.  

```{r MCMC, eval=FALSE}
# THIS WILL TAKE A LONG TIME TO RUN
lf_df_wt <- as.list(base_lfd_df[, 2:4])

dl <- blicc_dat(
  model_name = "Base: Mk ~ Fixed",
  LLB = base_lfd_df$len,
  fq = lf_df_wt,
  Linf = c(sp_par$vonBLinf, 2),
  sel_fun = c(4L, 4L, 4L),  # Selectivity function indices: 1 = logistic, 2 = normal, 3 = ss_normal, 4 = ds_normal
  Catch = cprop,
  gear_names = c("Estuarine set bagnet", "Gill net", "Marine set bagnet"),
  Mk = GR_MK,
  a = a,
  b = b,
  L50 = alt_L50
)

stf_MFixed <- blicc_fit(dl)
res_MFixed <- blicc_ref_pts(stf_MFixed, dl)

# Inverse Length M
mean_length <- sum(unlist(lf_df_wt) * rep((base_lfd_df$len + 0.5), dl$NG)) / 
               sum(unlist(lf_df_wt))

dl <- set_Mk(dl, ref_length=mean_length, 
             model_name = "Base: Mk ~ Inverse Length")

stf_MVari <- blicc_fit(dl)
res_MVari <- blicc_ref_pts(stf_MVari, dl)
# Results are saved to avoid having to refit the model.  
save(stf_MFixed, res_MFixed, stf_MVari, res_MVari, 
     file=here("output", paste0(species_name, "_SPR.rda")))
```


```{r Load_final_results}
load(file=here("output", paste0(species_name, "_SPR.rda")))
```

For both models, the MCMC converged. All MCMC effective sample sizes are above 500 and all Rhat are below 1.05.  

```{r ResultsTable_MFixed}
blicc_results(res_MFixed) |>
  flextable() |>
  colformat_double(j=c(2,3,5), digits=3) |>
  colformat_double(j=c(4), digits=0) |>
  flextable::set_caption(as_paragraph("Table ", as.character(Table_Number), 
                         " : Summary of parameter estimates for the ", 
               as_i(species_name), " fixed M model fit")) |>
  autofit()
Table_Number <- Table_Number + 1
```



```{r ResultsTable_MVari}
blicc_results(res_MVari) |>
  flextable() |>
  colformat_double(j=c(2,3,5), digits=3) |>
  colformat_double(j=c(4), digits=0) |>
  flextable::set_caption(as_paragraph("Table ", as.character(Table_Number), 
                         " : Summary of parameter estimates for the ", 
               as_i(species_name), " inverse length M model fit")) |>
  autofit()
Table_Number <- Table_Number + 1
```

Comparing the posterior results to the priors, the fishing mortality and selectivity parameters were reasonably well supported by the data. On balance, the models favoured higher Linf and lower natural mortality although these parameters depend heavily on the input priors. Likewise there was significant uncertainty associated with the growth variability (Galpha) and the observation error is high (NB_phi), suggesting low effective sampling size (usually because fish are not randomly sampled from the catch and catches are not random samples of the population).  

```{r ParameterVariation, fig.cap = "__Fig. MCMC parameter plots for the fixed and inverse-length models. Both models had the same priors.__"}
plotFixed <- bayesplot::mcmc_parcoord(
  as.array(stf_MFixed, 
        pars=c("nNB_phi", "nSm", "nFk", "nMk", "nGalpha", "nLinf")), 
  np = bayesplot::nuts_params(stf_MFixed)) +
  geom_hline(yintercept=0) +
  geom_hline(yintercept=c(1.96, -1.96), linetype="dotted") + 
  ggtitle("M ~ Fixed") +
  theme(axis.text=element_text(size=8), 
        plot.title=element_text(size=12)) + 
  coord_flip() 
plotVari <- bayesplot::mcmc_parcoord(
  as.array(stf_MVari, 
        pars=c("nNB_phi", "nSm", "nFk", "nMk", "nGalpha", "nLinf")), 
  np = bayesplot::nuts_params(stf_MVari)) +
  geom_hline(yintercept=0) +
  geom_hline(yintercept=c(1.96, -1.96), linetype="dotted") + 
  ggtitle("M ~ Inverse Length") +
  theme(axis.text=element_text(size=8), 
        plot.title=element_text(size=12)) + 
  coord_flip()
cowplot::plot_grid(plotFixed, plotVari, nrow=1, label_size=10)
```


```{r ObsExp_MFixed, fig.cap = "__Fig. Observed-expected plots for the fixed M model__"}
plot_expected_frequency(res_MFixed, Gear = 1:3)
```


```{r Resid_MFixed, fig.cap = "__Fig. Residual plots for the fixed M model__"}
plot_residuals(res_MFixed)
```


```{r ObsExp_MVari, fig.cap = "__Fig. Observed-expected plots for the inverse-length M model__"}
plot_expected_frequency(res_MVari, Gear = 1:3)
```



```{r Resid_MVari, fig.cap = "__Fig. Residual plots for the variable M model__"}
plot_residuals(res_MVari)
```


Although there is little discernible difference in fits among the observed-expected plots, the inverse-length M model has a better fit to the data as demonstrated by the increased log-probability (Fixed M lp__ = `r format(mean(res_MFixed$rp_df$lp__), digits=4)` Inverse-length M lp__ = `r format(mean(res_MVari$rp_df$lp__), digits=4)`).  

```{r Selectivity_MFinal, fig.cap = "__Fig. Selectivity for fixed and inverse-length M models__"}
lx_df <- rbind(mutate(res_MFixed$lx_df, Model="M ~ Fixed"),
               mutate(res_MVari$lx_df, Model="M ~ Inverse Length"))
lx_df |>
    dplyr::select(Model, Sgroup, Lgroup, sel) |>
    dplyr::group_by(Model, Sgroup, Lgroup) |>
    dplyr::summarise(
      sel_m = mean(sel),
      sel_10 = stats::quantile(sel, probs = c(0.10), names = F),
      sel_90 = stats::quantile(sel, probs = c(0.90), names = F),
    ) |>
    dplyr::ungroup() |>
    dplyr::mutate(LMP = res_MFixed$ld$LMP[as.integer(Lgroup)]) |>
    ggplot2::ggplot(ggplot2::aes(x = LMP, fill=Sgroup, colour=Sgroup)) +
    ggplot2::geom_ribbon(ggplot2::aes(ymin = sel_10, ymax = sel_90),
      alpha = 0.5
    ) +
    ggplot2::geom_line(ggplot2::aes(y = sel_m)) +
    ggplot2::labs(x = "Length", y = "Selectivity", fill="Gear", colour="Gear") +
  facet_wrap(vars(Model))
```

```{r SPR, fig.cap = "__Fig. Joint SPR density for the fixed and inverse-length M models.__"}
rp_df <- rbind(mutate(res_MFixed$rp_df, Model="M ~ Fixed"),
               mutate(res_MVari$rp_df, Model="M ~ Inverse Length"))

  ggplot2::ggplot(rp_df, ggplot2::aes(SPR, fill=Model)) +
    ggplot2::geom_density(alpha=0.5) +
    ggplot2::geom_vline(ggplot2::aes(xintercept = 0.2),
      colour = "red",
      linetype = 2
    ) +
    ggplot2::geom_vline(ggplot2::aes(xintercept = 0.4),
      colour = "green",
      linetype = 2
    ) +
    scale_fill_viridis_d() +
    ggplot2::coord_cartesian(xlim = c(0, 1)) +
    ggplot2::labs(x = "Spawning Potential Ratio", y = "Probability Density")
```


```{r plot_FkF40_density, fig.cap = "__Fig. F/F40 density for the fixed and inverse-length M models.__"}
plot_grid(plot_FkF40_density(res_MFixed) + ggtitle("M ~ Fixed"),
          plot_FkF40_density(res_MVari) + ggtitle("M ~ Inverse Length"))
```

For the SPR and yield contour plots, the marine set bagnet is used as the reference gear, although the yield changes would be applied across all gears equally.  

```{r SPRContour_MFixed, fig.cap = "__Fig. SPR contour plot for the fixed M model.__"}
# Axes reference is for the marine set bagnet.
plot_SPR_contour(res_MFixed)  
```


```{r SPRContour_MVari, fig.cap = "__Fig. SPR contour plot for the inverse-length M model.__"}
# Axes reference is for the marine set bagnet.
plot_SPR_contour(res_MVari)
```


```{r YPRContour_MFixed, fig.cap = "__Fig. Yield contour plot for the fixed M model.__"}
plot_YPR_contour(res_MFixed)
```


```{r YPRContour_MVari, fig.cap = "__Fig. Yield contour plot for the inverse-length M model.__"}
plot_YPR_contour(res_MVari)
```

When examining what length frequency data might look like under different fishing regimes, it can be seen that changes are likely to be small. For each reference point SPR20% to SPR40%, the current data are predominantly within the 95% predictive interval. Detecting changes in fishing mortality using length frequency alone is possible, but would require a robust sampling system. The high observation error might be reduced by a well designed sampling system.  

```{r plot_efq_FRP_MFixed, fig.cap = "__Fig. Expected length frequency under different fishing mortalities for the fixed M model.__"}
plot_efq_FRP(res_MFixed, Gear="Marine set bagnet")
```

```{r plot_efq_FRP_MVari, fig.cap = "__Fig. Expected length frequency under different fishing mortalities for the inverse-length M model.__"}
plot_efq_FRP(res_MVari, Gear="Marine set bagnet")
```

Changing the selectivity to achieve improve yields and sustainability should give clear changes in length composition. The model suggests that yields will improve if fish are caught at a greater size, moving the modal catch from around 25cm to 30cm.  

```{r plot_efq_SRP_MFixed, fig.cap = "__Fig. Expected length frequency under different selectivities for the fixed M model.__"}
plot_efq_SRP(res_MFixed, Gear="Marine set bagnet")
```


```{r plot_efq_SRP_MVari, fig.cap = "__Fig. Expected length frequency under different selectivities for the inverse-length M model.__"}
plot_efq_SRP(res_MVari, Gear="Marine set bagnet")
```


# Conclusion  

The two models can be combined. The working group decided it was reasonable to assume both models were equally likely, so the MCMC output can be combined into a single set for the calculation of probability densities.   

```{r Combined_SPR_plot, fig.cap = "__Fig. Combined model SPR density.__"}
  ggplot2::ggplot(rp_df, ggplot2::aes(SPR)) +
    ggplot2::geom_density(fill = "blue", alpha=0.5) +
    ggplot2::geom_vline(ggplot2::aes(xintercept = 0.2),
      colour = "red",
      linetype = 2
    ) +
    ggplot2::geom_vline(ggplot2::aes(xintercept = 0.4),
      colour = "green",
      linetype = 2
    ) +
    ggplot2::coord_cartesian(xlim = c(0, 1)) +
    ggplot2::labs(x = "Spawning Potential Ratio", y = "Probability Density")
```

Based on combined model results (Table `r `Table_Number`), there is less than 2% probability that the stock is below the limit reference point (SPR<20%) but around 86% probability it is below a precautionary target (SPR<40%).  

```{r SPR_Summary_Table}
Nr <- nrow(rp_df)
with(rp_df, tibble(Mean = mean(SPR)*100, 
                   SD = sd(SPR)*100,
                   `Pr < 20%` = sum(SPR<0.2)/Nr,
                   `Pr < 30%` = sum(SPR<0.3)/Nr,
                   `Pr < 40%` = sum(SPR<0.4)/Nr) )|>
  flextable() |>
  colformat_double(digits=3) |>
  flextable::set_caption(as_paragraph("Table ", as.character(Table_Number), 
                         " : Summary of SPR estimates and probabilities for ", 
               as_i(species_name), " combined model fit")) |>
  autofit()
Table_Number <- Table_Number + 1
```

Length frequencies are insensitive indicators of changes in fishing mortality. Reliance on length frequency alone will result in relatively imprecise estimates of stock status. Unsurprisingly, length frequency will provide good information on changes in selectivity (e.g. mesh size). 

On balance of the evidence, the `r species_name` stock is not overfished (SPR > 20%). However, results also suggest that yield might be improved with the current fishing effort by raising the size at capture. For the current fishery, yield would be maximised by raising the marine set bagnet selectivity mode from `r format(mean(sapply(rp_df$Sm, function(x) x[7])), digits=3)` to `r format(mean(sapply(rp_df$SMY, function(x) x[7])), digits=3)`. This increase might be achieved by an increase in mesh size or adjustment in fishing locations, although the impact on other species capture would need to be taken into account.  Clearly, the estuarine catches need to be minimised on the same basis. While equally raising the size of capture by gillnets would be beneficial, gillnets are generally catching bombay duck as bycatch, so adjustment of catch size in this gear will be difficult.  

Assuming an MSY proxy $F_{0.1}$, we can calculate F/FMSY which indicates the performance of the fishery with respect to optimising yield (under the current selectivity). There is little difference between the models, and results suggest that fishing mortaltiy is likely below F0.1.  

Table Median and 80% credible interval of fishing mortality relative to $F_{0.1}$ as a proxy for $F / F_{MSY}$ for the two final model scenarios.

```{r}
bind_rows(
    quantile(res_MFixed$rp_df$SPR, probs= c(0.5, 0.1, 0.9)) |>
    as_tibble_row() |>
    mutate(Variable = "SPR", Model = "Fixed M"),
    quantile(res_MVari$rp_df$SPR, probs= c(0.5, 0.1, 0.9)) |>
    as_tibble_row()|>
    mutate(Variable = "SPR", Model = "Length-inverse M"),
    quantile(c(res_MFixed$rp_df$SPR, 
               res_MVari$rp_df$SPR), probs= c(0.5, 0.1, 0.9)) |>
    as_tibble_row() |>
    mutate(Variable = "SPR", Model = "Combined"),
  with(res_MFixed, vapply(rp_df$Fk, \(x) x[1], FUN.VALUE=0, USE.NAMES=FALSE) / 
         vapply(rp_df$F01, \(x) x[1], FUN.VALUE=0, USE.NAMES=FALSE)) |>
    quantile(probs= c(0.5, 0.1, 0.9)) |>
    as_tibble_row() |>
    mutate(Variable = "F/FMSY", Model = "Fixed M"),
  with(res_MVari, vapply(rp_df$Fk, \(x) x[1], FUN.VALUE=0, USE.NAMES=FALSE) / 
         vapply(rp_df$F01, \(x) x[1], FUN.VALUE=0, USE.NAMES=FALSE)) |>
    quantile(probs= c(0.5, 0.1, 0.9)) |>
    as_tibble_row()|>
    mutate(Variable = "F/FMSY", Model = "Length-inverse M"),
  cbind(with(res_MFixed, vapply(rp_df$Fk, \(x) x[1], FUN.VALUE=0, USE.NAMES=FALSE) / 
          vapply(rp_df$F01, \(x) x[1], FUN.VALUE=0, USE.NAMES=FALSE)),
        with(res_MVari, vapply(rp_df$Fk, \(x) x[1], FUN.VALUE=0, USE.NAMES=FALSE) / 
          vapply(rp_df$F01, \(x) x[1], FUN.VALUE=0, USE.NAMES=FALSE))) |>
    quantile(probs= c(0.5, 0.1, 0.9)) |>
    as_tibble_row() |>
    mutate(Variable = "F/FMSY", Model = "Combined")) |>
  select(Variable, Model, everything()) |>
  flextable() |>
  colformat_double(digits=3) |>
  autofit()
```


# References  

Lorenzen, K. 2022. Size- and age-dependent natural mortality in fish populations: Biology, models, implications, and a generalized length-inverse mortality paradigm. Fisheries Research 255, https://doi.org/10.1016/j.fishres.2022.106454.
Betancourt, M.(2017) A conceptual introduction to Hamiltonian Monte Carlo. https://arxiv.org/abs/1701.02434
Hordyk, A., Ono, K., Valencia, S., Loneragan, N., and Prince, J. 2015. A novel length-based empirical estimation method of spawning potential ratio (SPR), and tests of its performance, for small-scale, data-poor fisheries. ICES Journal of Marine Science, 72: 217231.  
Prince, J., Hordyk, A., Valencia, S. R., Loneragan, N., and Sainsbury, K. 2015. Revisiting the concept of BevertonHolt life-history invariants with the aim of informing data-poor fisheries assessment. ICES Journal of Marine Science, 72: 194203.  


R Packages
stan
rstan
posterior
bayesplot
tidyverse
cowplot

